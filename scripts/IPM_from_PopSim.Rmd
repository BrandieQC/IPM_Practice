---
title: "IPM_from_PopSim"
author: "Brandie QC"
date: "`r Sys.Date()`"
output: 
  html_document: 
    keep_md: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# IPM from Population Simulation

\*Simulations done in "Population_Sim_Trial.Rmd" file (currently using AlphaSimR)

**Goal:** Compare IPM created from just phenotypes from the simulation to an IPM created from phenotypes + genotype scores.

## Libraries

```{r}
library(tidyverse)
library(broom)
library(broom.mixed)
library(magrittr)
library(lmerTest)
conflicted::conflicts_prefer(lmerTest::lmer)
conflicted::conflicts_prefer(dplyr::filter)
conflicted::conflicts_prefer(dplyr::mutate)
```

## Load the data
```{r}
simpop <- read_csv("../output/PopSim_Phenos-Genos_v3.csv")
names(simpop)
#logit_pheno = scaled probability/phenotype
#_geno = genotype score for that trait 
#size = height calculated from simulated Weibull parameters (alpha, beta, k, and delta)
####Note: we will use the genotype score for k for this 
#elapsed_weeks = interval between weeks - should all be 1 in this data
```

### Add size next and weekly surv
```{r}
unique(simpop$established) #NA = did not germinate, 1 = established (survived first 3 weeks in field); 0 = did not establish
unique(simpop$y1surv) #NA = did not establish, 1 = survived to week 12; 0 = did not survive 

simpop_timeprep <- simpop %>%
  mutate(weeks = as.numeric(week - 1), #Weeks since week 1 (equivalent to pre-transplant or initial size) 
         size = if_else(germinated==0, NA, size), #no size if no germ
         weekly.surv.prob = if_else(is.na(y1surv), NA,
                                    if_else(y1surv==0, 0,  
                                            y1surv.prob^(1/(8)))) #get weekly surv prob post establishment
         ) %>%   
  mutate(surv=if_else(germinated==0, NA, #surv = NA if you did not germ 
                        if_else(week==1, 1, #if you did germinate, assume you survived to week 1 (equivalent to pre-transplant size time point)
                                if_else(established==0, 0, #surv = 0 after week 1 if you did not establish 
                                        if_else(week<5, 1, #if you did establish, your surv is equal to 1 for the first 3 weeks post-transplant 
                                                rbinom(n(), size = 1, prob = weekly.surv.prob)) #your survival for weeks 5-12 is then based on weekly surv prob
                                        )))) %>% 
  group_by(Indiv_ID) %>% 
  mutate(surv = cummin(surv)) %>% # if dead in a previous week, stay dead
  mutate(death.week=if_else(y1surv==1, NA, #if survive year 1 no death week 
                            first(week, order_by = surv)) #first week where surv = 0 
           ) %>% 
  #note we only have establishment and y1surv survival from the pop sim --> little weekly variation 
  mutate(size_next = lead(size, order_by = week), #next time point's size) 
         size = if_else(is.na(death.week), size,
                        if_else(week>death.week, NA, size))) %>%  
  ungroup() %>% 
  mutate(size_next=if_else(surv==0, NA, size_next))

simpop_timeprep %>% #look at data for a few indivs to see if above worked
  drop_na(surv) %>% 
  select(Indiv_ID, week, weeks, germinated, established, y1surv, size, size_next, surv, death.week) %>% 
  filter(Indiv_ID<25)

simpop_timeprep_surv <- simpop_timeprep %>% drop_na(surv, size) #for surv models 
simpop_timeprep_size <- simpop_timeprep %>% drop_na(size, size_next) #for size models 
simpop_timeprep %>% filter(is.na(flowering.prob))
```

### Scaling and transformations
```{r}
simpop_timeprep_surv %>%  #slightly skewed
  ggplot(aes(x=size)) +
  geom_histogram()

simpop_timeprep_surv_scaled <- simpop_timeprep_surv %>% 
  mutate(logSize=log(size),
         sqSize=sqrt(size)) 

simpop_timeprep_surv_scaled %>% #not better
  ggplot(aes(x=logSize)) +
  geom_histogram()

simpop_timeprep_surv_scaled %>% #not better
  ggplot(aes(x=sqSize)) +
  geom_histogram()
```

## Survival Models

### Phenos Only
```{r}
surv.models_pheno <- tribble(
  ~name,          ~f,
  "1_linear_size",                 "surv ~ size", 
  "2_linear_weeks",                "surv ~ size + weeks",
  "3a_quadratic_size",             "surv ~ size + I(size^2)", 
  "3b_quadratic_size_weeks",       "surv ~ size + I(size^2) + weeks", 
  "4a_cubic_size",                 "surv ~ size + I(size^2) + I(size^3)",
  "4b_cubic_size_weeks",           "surv ~ size + I(size^2) + I(size^3) + weeks"
)

#run the models 
surv.models_pheno <- surv.models_pheno %>%
  mutate(glm = map(f, ~ glm(as.formula(.), 
                            data = simpop_timeprep_surv, 
                            family = "binomial")), #, #run the models 
         predict = map(glm, predict, type = "response"), 
         glance = map(glm, tidy),
         AIC = map(glm, AIC),
         BIC = map(glm, BIC)) #glance at the model results

surv.models_pheno %>% select(-f, -glm, -predict) %>% unnest(BIC) %>% arrange(BIC) #look at the model fitting info 
surv.models_pheno %>% select(-f, -glm, -predict) %>% unnest(AIC) %>% arrange(AIC) #look at the model fitting info 
#3b_quadratic_size_weeks best by AIC and BIC
```

```{r}
survival.model.final_pheno <- surv.models_pheno %>% filter(name == "3b_quadratic_size_weeks") %>% pull(glm) %>% magrittr::extract2(1)
summary(survival.model.final_pheno)
```

#### Predicted vs. Observed Survival
```{r}
simpop_timeprep_surv %>% 
  mutate(pred_fixef = predict(survival.model.final_pheno, newdata = ., type="response", re.form = NA)) %>% 
  ggplot(aes(x = size, y = surv)) +
  geom_point(alpha=.2) +
  geom_line(aes(y = pred_fixef), 
            color = "blue", 
            size = 1.2, alpha=0.3) 
```

### Phenos + Genos
```{r}
surv.models_genos <- tribble(
  ~name,          ~f,
  "1a_linear_size",                 "surv ~ size", 
  "1b_linear_size_genos",           "surv ~ size + establishment.logit_geno + y1surv.logit_geno", 
  "2a_linear_weeks",                "surv ~ size + weeks",
  "2b_linear_weeks_geno",           "surv ~ size + weeks + establishment.logit_geno + y1surv.logit_geno",
  "3a_quadratic_size",              "surv ~ size + I(size^2)", 
  "3b_quadratic_size_weeks",        "surv ~ size + I(size^2) + weeks", 
  "3c_quadratic_size_weeks_geno",   "surv ~ size + I(size^2) + weeks + establishment.logit_geno + y1surv.logit_geno",
  "4a_cubic_size",                  "surv ~ size + I(size^2) + I(size^3)",
  "4b_cubic_size_weeks",            "surv ~ size + I(size^2) + I(size^3) + weeks",
  "4c_cubic_size_weeks_geno",       "surv ~ size + I(size^2) + I(size^3) + weeks + establishment.logit_geno + y1surv.logit_geno"
)

#run the models 
surv.models_genos <- surv.models_genos %>%
  mutate(glm = map(f, ~ glm(as.formula(.), 
                            data = simpop_timeprep_surv, 
                            family = "binomial")), #, #run the models 
         predict = map(glm, predict, type = "response"), 
         glance = map(glm, tidy),
         AIC = map(glm, AIC),
         BIC = map(glm, BIC)) #glance at the model results

surv.models_genos %>% select(-f, -glm, -predict) %>% unnest(BIC) %>% arrange(BIC) #look at the model fitting info 
surv.models_genos %>% select(-f, -glm, -predict) %>% unnest(AIC) %>% arrange(AIC) #look at the model fitting info 
#3b_quadratic_size_weeks best by AIC and BIC
#3c_quadratic_size_weeks_geno 3rd best by AIC 
```

```{r}
survival.model.final_genos <- surv.models_genos %>% filter(name == "3c_quadratic_size_weeks_geno") %>% pull(glm) %>% magrittr::extract2(1)
summary(survival.model.final_genos)
```

#### Predicted vs. Observed Survival
```{r}
simpop_timeprep_surv %>% 
  mutate(pred_fixef = predict(survival.model.final_genos, newdata = ., type="response", re.form = NA)) %>% 
  ggplot(aes(x = size, y = surv)) +
  geom_point(alpha=.2) +
  geom_line(aes(y = pred_fixef), 
            color = "blue", 
            size = 1.2, alpha=0.3) 
```

## Growth Models

### Observed Patterns
```{r}
simpop_timeprep_size %>% 
  ggplot(aes(x=size, y=size_next)) +
  geom_point()  +
  geom_abline() +
  geom_smooth(method = "lm")
```

### Phenos Only
```{r}
size.models_pheno <- tribble(
  ~name,          ~f,
  "1_linear_size",                 "size_next ~ size", 
  "2_linear_weeks",                "size_next ~ size + weeks",
  "3a_quadratic_size",             "size_next ~ size + I(size^2)", 
  "3b_quadratic_size_weeks",       "size_next ~ size + I(size^2) + weeks", 
  "4a_cubic_size",                 "size_next ~ size + I(size^2) + I(size^3)",
  "4b_cubic_size_weeks",           "size_next ~ size + I(size^2) + I(size^3) + weeks"
)

#run the models 
size.models_pheno <- size.models_pheno %>%
  mutate(lm = map(f, ~ lm(as.formula(.), 
                            data = simpop_timeprep_size)), #, #run the models 
         predict = map(lm, predict), 
         glance = map(lm, glance)) #glance at the model results

size.models_pheno %>% select(-f, -lm, -predict) %>% unnest(glance) %>% arrange(BIC) #look at the model fitting info 
size.models_pheno %>% select(-f, -lm, -predict) %>% unnest(glance) %>% arrange(AIC) #look at the model fitting info 
#3b_quadratic_size_weeks best by AIC and BIC
```

```{r}
size.model.final_pheno <- size.models_pheno %>% filter(name == "3b_quadratic_size_weeks") %>% pull(lm) %>% magrittr::extract2(1)
summary(size.model.final_pheno)
```

#### Predicted vs. Observed Growth
```{r}
simpop_timeprep_size %>% 
  cbind(predicted={size.models_pheno %>% filter(name=="3b_quadratic_size_weeks") %>% pull(predict) %>% unlist()}) %>%
  ggplot(aes(x=size_next, y = predicted)) +
  geom_point() +
  geom_abline(color="skyblue2")
```

### Phenos + Genos
```{r}
size.models_genos <- tribble(
  ~name,          ~f,
  "1a_linear_size",                 "size_next ~ size", 
  "1b_linear_size_geno",            "size_next ~ size + k_geno", 
  "2a_linear_weeks",                "size_next ~ size + weeks",
  "2b_linear_weeks_geno",           "size_next ~ size + weeks + k_geno",
  "3a_quadratic_size",              "size_next ~ size + I(size^2)", 
  "3b_quadratic_size_weeks",        "size_next ~ size + I(size^2) + weeks", 
  "3c_quadratic_size_weeks_geno",   "size_next ~ size + I(size^2) + weeks + k_geno",
  "4a_cubic_size",                  "size_next ~ size + I(size^2) + I(size^3)",
  "4b_cubic_size_weeks",            "size_next ~ size + I(size^2) + I(size^3) + weeks",
  "4c_cubic_size_weeks_geno",       "size_next ~ size + I(size^2) + I(size^3) + weeks + k_geno"
)

#run the models 
size.models_genos <- size.models_genos %>%
  mutate(lm = map(f, ~ lm(as.formula(.), 
                            data = simpop_timeprep_size)), #, #run the models 
         predict = map(lm, predict), 
         glance = map(lm, glance)) #glance at the model results

size.models_genos %>% select(-f, -lm, -predict) %>% unnest(glance) %>% arrange(BIC) #look at the model fitting info 
size.models_genos %>% select(-f, -lm, -predict) %>% unnest(glance) %>% arrange(AIC) #look at the model fitting info 
#3c_quadratic_size_weeks_geno best by AIC and BIC
```

```{r}
size.model.final_genos <- size.models_genos %>% filter(name == "3c_quadratic_size_weeks_geno") %>% pull(lm) %>% magrittr::extract2(1)
summary(size.model.final_genos)
```

#### Predicted vs. Observed Growth
```{r}
simpop_timeprep_size %>% 
  cbind(predicted={size.models_genos %>% filter(name=="3c_quadratic_size_weeks_geno") %>% pull(predict) %>% unlist()}) %>%
  ggplot(aes(x=size_next, y = predicted)) +
  geom_point() +
  geom_abline(color="skyblue2")
```

## P Matrix

### Make a dataframe to store the parameters
```{r}
params=data.frame(
  surv.int=NA, # Intercept from logistic regression of survival
  surv.slope1=NA, # Slope from logistic regression of survival
  surv.slope2=NA, # Quadratic slope from logistic regression of survival
  growth.int=NA, # Intercept from linear regression of growth
  growth.slope1=NA, # Slope from linear regression of growth
  growth.slope2=NA, # Quadratic slope from linear regression of growth
  growth.sd=NA # Residual sd from the linear regression of growth
)

params_phenos <- params
params_genos <- params
```

### Use broom:tidy to create a df with the coef from each model
```{r}
surv.coefs_pheno <- surv.models_pheno %>% 
  filter(name == "3b_quadratic_size_weeks") %>%
  mutate(coefs = map(glm, tidy)) %>% 
  select(name, f, coefs) %>% 
  unnest(coefs) 

params_phenos$surv.int <- surv.coefs_pheno %>% filter(term == "(Intercept)") %>% pull(estimate)
params_phenos$surv.slope1 <- surv.coefs_pheno %>% filter(term == "size") %>% pull(estimate)
params_phenos$surv.slope2 <- surv.coefs_pheno %>% filter(term == "I(size^2)") %>% pull(estimate)
```

```{r}
surv.coefs_genos <- surv.models_genos %>% 
  filter(name == "3c_quadratic_size_weeks_geno") %>% 
  mutate(coefs = map(glm, tidy)) %>% 
  select(name, f, coefs) %>% 
  unnest(coefs) 

params_genos$surv.int <- surv.coefs_genos %>% filter(term == "(Intercept)") %>% pull(estimate)
params_genos$surv.slope1 <- surv.coefs_genos %>% filter(term == "size") %>% pull(estimate)
params_genos$surv.slope2 <- surv.coefs_genos %>% filter(term == "I(size^2)") %>% pull(estimate)
```

```{r}
growth.coefs_pheno <- size.models_pheno %>% 
  filter(name == "3b_quadratic_size_weeks") %>% 
  mutate(coefs = map(lm, tidy)) %>% 
  select(name, f, coefs) %>% 
  unnest(coefs) 

params_phenos$growth.int <- growth.coefs_pheno %>% filter(term == "(Intercept)") %>% pull(estimate)
params_phenos$growth.slope1 <- growth.coefs_pheno %>% filter(term == "size") %>% pull(estimate)
params_phenos$growth.slope2 <- growth.coefs_pheno %>% filter(term == "I(size^2)") %>% pull(estimate)

#Pull sigma which is the _modeled_ standard deviation of the residuals.  Merow uses observed sd of residuals.  
params_phenos$growth.sd <- size.models_pheno %>% filter(name == "3b_quadratic_size_weeks") %>% unnest(glance) %>% pull(sigma)
```

```{r}
growth.coefs_genos <- size.models_genos %>% 
  filter(name == "3c_quadratic_size_weeks_geno") %>% 
  mutate(coefs = map(lm, tidy)) %>% 
  select(name, f, coefs) %>% 
  unnest(coefs) 

params_genos$growth.int <- growth.coefs_genos %>% filter(term == "(Intercept)") %>% pull(estimate)
params_genos$growth.slope1 <- growth.coefs_genos %>% filter(term == "size") %>% pull(estimate)
params_genos$growth.slope2 <- growth.coefs_genos %>% filter(term == "I(size^2)") %>% pull(estimate)

#Pull sigma which is the _modeled_ standard deviation of the residuals.  Merow uses observed sd of residuals.  
params_genos$growth.sd <- size.models_genos %>% filter(name == "3c_quadratic_size_weeks_geno") %>% unnest(glance) %>% pull(sigma)
```

### Define the functions
```{r}
# 1. survival probability function
##This is inverse logit.  Provides survival probability based on size.
s.x_phenos=function(x,params_phenos) {
  u=exp(params_phenos$surv.int + params_phenos$surv.slope1*x + params_phenos$surv.slope2*x^2)
  return(u/(1+u)) 
}

# 2. growth function
## Return a probability distribution of new sizes at t+1 (xp) at a given size x.  
g.yx_phenos=function(xp,x,params_phenos) {
  dnorm(xp,mean=params_phenos$growth.int + params_phenos$growth.slope1*x + params_phenos$growth.slope2*x^2, sd=params_phenos$growth.sd)
}
```

```{r}
# 1. survival probability function
##This is inverse logit.  Provides survival probability based on size.
s.x_genos=function(x,params_genos) {
  u=exp(params_genos$surv.int + params_genos$surv.slope1*x + params_genos$surv.slope2*x^2)
  return(u/(1+u)) 
}

# 2. growth function
## Return a probability distribution of new sizes at t+1 (xp) at a given size x.  
g.yx_genos=function(xp,x,params_genos) {
  dnorm(xp,mean=params_genos$growth.int + params_genos$growth.slope1*x + params_genos$growth.slope2*x^2, sd=params_genos$growth.sd)
}
```

### Define the structure of the IPM
```{r}
# the sizes we are integrating over
minSize<-min(simpop_timeprep$size,na.rm=T) 
maxSize<-max(simpop_timeprep$size,na.rm=T) 

n=100 # dimensions of the matrix 

b=minSize+c(0:n)*(maxSize-minSize)/n # boundary points
y=0.5*(b[1:n]+b[2:(n+1)]) # mesh points
h=y[2]-y[1] # step size
```

### Make the matrices (G, S, and P)
```{r}
G_phenos=h*outer(y,y,g.yx_phenos,params=params_phenos) # growth matrix

S_phenos=s.x_phenos(y,params=params_phenos) # survival at each size midpoint

P_phenos=G_phenos # placeholder; redefine P on the next line
for(i in 1:n) P_phenos[,i]=G_phenos[,i]*S_phenos[i] # growth/survival matrix
```

```{r}
G_genos=h*outer(y,y,g.yx_genos,params=params_genos) # growth matrix

S_genos=s.x_genos(y,params=params_genos) # survival at each size midpoint

P_genos=G_genos # placeholder; redefine P on the next line
for(i in 1:n) P_genos[,i]=G_genos[,i]*S_genos[i] # growth/survival matrix
```

### Plot the matrix
```{r}
P_phenos %>% as_tibble() %>%
  set_colnames(y) %>% #column names = each size mesh point 
  mutate(size.t1=y) %>%
  pivot_longer(-size.t1, names_to = "size.t", names_transform = as.numeric) %>%
  ggplot(aes(x=size.t, y = size.t1)) +
  geom_raster(aes(fill = value)) + #basic contour with fill determined by the growth*surv value 
  geom_contour(aes(z = value),lwd=.25) + #adds contour lines 
  geom_abline(intercept=0, slope = 1, color="gray90", lty=5) + #add 1:1 line 
  scale_fill_viridis_c(option = "plasma") + #change contour colors 
  labs(x = "Size (t)", y = "Size (t + 1)", title = "P Matrix: Phenos Only") +
  coord_equal() + #make it a square plot 
  theme_bw()
```
```{r}
P_genos %>% as_tibble() %>%
  set_colnames(y) %>% #column names = each size mesh point 
  mutate(size.t1=y) %>%
  pivot_longer(-size.t1, names_to = "size.t", names_transform = as.numeric) %>%
  ggplot(aes(x=size.t, y = size.t1)) +
  geom_raster(aes(fill = value)) + #basic contour with fill determined by the growth*surv value 
  geom_contour(aes(z = value),lwd=.25) + #adds contour lines 
  geom_abline(intercept=0, slope = 1, color="gray90", lty=5) + #add 1:1 line 
  scale_fill_viridis_c(option = "plasma") + #change contour colors 
  labs(x = "Size (t)", y = "Size (t + 1)", title = "P Matrix: Phenos + Genos") +
  coord_equal() + #make it a square plot 
  theme_bw()
```
### Check for eviction
```{r}
plot(y,s.x_phenos(y,params_phenos), #fitted survival model 
     xlab="Size",type="l",
        ylab="Survival Probability",lwd=12)
     points(y,apply(P_phenos,2,sum),col="red",lwd=3,cex=.1,pch=19) # column sums 
#some eviction at larger sizes
```
```{r}
plot(y,s.x_genos(y,params_genos), #fitted survival model 
     xlab="Size",type="l",
        ylab="Survival Probability",lwd=12)
     points(y,apply(P_genos,2,sum),col="red",lwd=3,cex=.1,pch=19) # column sums 
#some eviction at larger sizes
```
#### Eviction correction using a constant 
```{r}
Pc_phenos=G_phenos # placeholder; redefine P on the next line
for(i in 1:n) Pc_phenos[,i]=G_phenos[,i]*S_phenos[i] # growth/survival matrix
nvals <- colSums(Pc_phenos, na.rm = TRUE)
Pc_phenos <- t((t(Pc_phenos)/nvals) * s.x_phenos(y, params=params_phenos))

plot(y,s.x_phenos(y,params_phenos),xlab="Size",type="l",
        ylab="Survival Probability",lwd=12)
     points(y,apply(Pc_phenos,2,sum),col="red",lwd=3,cex=.1,pch=19) # solution worked
```

```{r}
Pc_genos=G_genos # placeholder; redefine P on the next line
for(i in 1:n) Pc_genos[,i]=G_genos[,i]*S_genos[i] # growth/survival matrix
nvals <- colSums(Pc_genos, na.rm = TRUE)
Pc_genos <- t((t(Pc_genos)/nvals) * s.x_genos(y, params=params_genos))

plot(y,s.x_genos(y,params_genos),xlab="Size",type="l",
        ylab="Survival Probability",lwd=12)
     points(y,apply(Pc_genos,2,sum),col="red",lwd=3,cex=.1,pch=19) # solution worked
```

#### Plot corrected P matrices 
```{r}
Pc_phenos %>% as_tibble() %>%
  set_colnames(y) %>% #column names = each size mesh point 
  mutate(size.t1=y) %>%
  pivot_longer(-size.t1, names_to = "size.t", names_transform = as.numeric) %>%
  ggplot(aes(x=size.t, y = size.t1)) +
  geom_raster(aes(fill = value)) + #basic contour with fill determined by the growth*surv value 
  geom_contour(aes(z = value),lwd=.25) + #adds contour lines 
  geom_abline(intercept=0, slope = 1, color="gray90", lty=5) + #add 1:1 line 
  scale_fill_viridis_c(option = "plasma") + #change contour colors 
  labs(x = "Size (t)", y = "Size (t + 1)", title = "P Matrix: Phenos Only") +
  coord_equal() + #make it a square plot 
  theme_bw()
```

```{r}
Pc_genos %>% as_tibble() %>%
  set_colnames(y) %>% #column names = each size mesh point 
  mutate(size.t1=y) %>%
  pivot_longer(-size.t1, names_to = "size.t", names_transform = as.numeric) %>%
  ggplot(aes(x=size.t, y = size.t1)) +
  geom_raster(aes(fill = value)) + #basic contour with fill determined by the growth*surv value 
  geom_contour(aes(z = value),lwd=.25) + #adds contour lines 
  geom_abline(intercept=0, slope = 1, color="gray90", lty=5) + #add 1:1 line 
  scale_fill_viridis_c(option = "plasma") + #change contour colors 
  labs(x = "Size (t)", y = "Size (t + 1)", title = "P Matrix: Phenos + Genos") +
  coord_equal() + #make it a square plot 
  theme_bw()
```

### Asymptotic Lambda Comparison
```{r}
(lam_pheno = Re(eigen(Pc_phenos)$values[1]))  #0.9760204
(lam_geno = Re(eigen(Pc_genos)$values[1]))  #0.9630443
#lambda slightly lower with genotypes added 
#both just below 1 (population growth)
```

### Sensitivities Comparison
```{r}
#prep:
w.eigen_pheno <- Re(eigen(Pc_phenos)$vectors[,1]) #right eigenvector
stable.dist_pheno <- w.eigen_pheno/sum(w.eigen_pheno)
v.eigen_pheno <- Re(eigen(t(Pc_phenos))$vectors[,1]) #left eigenvector 
repro.val_pheno <- v.eigen_pheno/v.eigen_pheno[1]

w.eigen_geno <- Re(eigen(Pc_genos)$vectors[,1]) #right eigenvector
stable.dist_geno <- w.eigen_geno/sum(w.eigen_geno)
v.eigen_geno <- Re(eigen(t(Pc_genos))$vectors[,1]) #left eigenvector 
repro.val_geno <- v.eigen_geno/v.eigen_geno[1]

#combine eigens to get sensitivity and elasticity matrices
v.dot.w_pheno = sum(stable.dist_pheno*repro.val_pheno)*h
sens_pheno = outer(repro.val_pheno,stable.dist_pheno)/v.dot.w_pheno
elas_pheno = matrix(as.vector(sens_pheno)*as.vector(Pc_phenos)/lam_pheno,nrow=n)

v.dot.w_geno = sum(stable.dist_geno*repro.val_geno)*h
sens_geno = outer(repro.val_geno,stable.dist_geno)/v.dot.w_geno
elas_geno = matrix(as.vector(sens_geno)*as.vector(Pc_genos)/lam_geno,nrow=n)

sens_pheno
sens_geno
#sensitivities are different 

elas_pheno
elas_geno 
#elasticities are different 
```

## Fecundity Constants

```{r}
fec2 <- 14 #Number of seeds produced per fruit - estimated from F1 crosses data sheet 

fec3 <- 0.001336 #Probability of germination within the year of seed production

fec4 <- 0.14 #Probability of seedling survival from the time of germination to the time of the next annual census t+1, corresponding to approximately 6 months
```

## Flowering Probability Models

### Prep dataframe 
```{r}
twomossize <- simpop_timeprep %>% 
  filter(week==9) %>% 
  select(Indiv_ID, size, flowered, flowering.logit_geno, fruitPerPlant_pheno, fruitPerPlant_geno) %>% 
  drop_na(size)
head(twomossize)
```

### Phenos Only
```{r}
fec0.models_pheno <- tribble(
  ~name,          ~f,
  "1_linear_size",      "flowered ~ 1 + size", 
  "2_quadratic_size",   "flowered ~ size + I(size^2)", 
  "3_cubic_size",       "flowered ~ size + I(size^2) + I(size^3)"
)

#run the models 
fec0.models_pheno <- fec0.models_pheno %>%
  mutate(glm = map(f, ~ glm(as.formula(.), 
                            data = twomossize, 
                            family = "binomial")), #run the models 
         predict = map(glm, predict, type = "response"), 
         glance = map(glm, tidy),
         AIC = map(glm, AIC),
         BIC = map(glm, BIC)) #glance at the model results

fec0.models_pheno %>% select(-f, -glm, -predict) %>% unnest(BIC) %>% arrange(BIC) #look at the model fitting info 
fec0.models_pheno %>% select(-f, -glm, -predict) %>% unnest(AIC) %>% arrange(AIC) #look at the model fitting info 

#1_linear_size best by AIC and BIC
```

```{r}
fec0.model.final_pheno <- fec0.models_pheno %>% filter(name == "1_linear_size") %>% pull(glm) %>% magrittr::extract2(1)
summary(fec0.model.final_pheno)
```

#### Predicted vs. Observed
```{r}
twomossize %>% 
  mutate(pred_fixef = predict(fec0.model.final_pheno, newdata = ., type="response", re.form = NA)) %>% 
  ggplot(aes(x = size, y = flowered)) +
  geom_point(alpha=.2) +
  geom_line(aes(y = pred_fixef), 
            color = "blue", 
            size = 1.2, alpha=0.3) 
```

### Phenos + Genos
```{r}
fec0.models_genos <- tribble(
  ~name,          ~f,
  "1a_linear_size",      "flowered ~ 1 + size", 
  "2a_quadratic_size",   "flowered ~ size + I(size^2)", 
  "3a_cubic_size",       "flowered ~ size + I(size^2) + I(size^3)",
  "1b_linear_size_genos",      "flowered ~ 1 + size + flowering.logit_geno", 
  "2b_quadratic_size_genos",   "flowered ~ size + I(size^2) + flowering.logit_geno", 
  "3b_cubic_size_genos",       "flowered ~ size + I(size^2) + I(size^3) + flowering.logit_geno"
)

#run the models 
fec0.models_genos <- fec0.models_genos %>%
  mutate(glm = map(f, ~ glm(as.formula(.), 
                            data = twomossize, 
                            family = "binomial")), #run the models 
         predict = map(glm, predict, type = "response"), 
         glance = map(glm, tidy),
         AIC = map(glm, AIC),
         BIC = map(glm, BIC)) #glance at the model results

fec0.models_genos %>% select(-f, -glm, -predict) %>% unnest(BIC) %>% arrange(BIC) #look at the model fitting info 
fec0.models_genos %>% select(-f, -glm, -predict) %>% unnest(AIC) %>% arrange(AIC) #look at the model fitting info 

#1a_linear_size best by AIC and BIC
#1b_linear_size_genos second best by BIC, 3rd best by AIC 
```

```{r}
fec0.model.final_genos <- fec0.models_genos %>% filter(name == "1b_linear_size_genos") %>% pull(glm) %>% magrittr::extract2(1)
summary(fec0.model.final_genos)
```

#### Predicted vs. Observed
```{r}
twomossize %>% 
  mutate(pred_fixef = predict(fec0.model.final_genos, newdata = ., type="response", re.form = NA)) %>% 
  ggplot(aes(x = size, y = flowered)) +
  geom_point(alpha=.2) +
  geom_line(aes(y = pred_fixef), 
            color = "blue", 
            size = 1.2, alpha=0.3) 
```
## Number Fruits/Plant Models
Filter to only reproductive plants 
```{r}
twomossize_fruits <- twomossize %>% 
  drop_na(fruitPerPlant_pheno)
head(twomossize_fruits)
summary(twomossize_fruits)
```

### Observed Patterns - check if poisson distribution appropriate 
```{r}
twomossize_fruits %>% 
  ggplot(aes(x=fruitPerPlant_pheno)) +
  geom_histogram()
#no poisson?
```

### Phenos Only
```{r}
fruits_models_pheno <- tribble(
  ~name,          ~f,
  "1_linear_size",      "fruitPerPlant_pheno ~ 1 + size", 
  "2_quadratic_size",   "fruitPerPlant_pheno ~ size + I(size^2)", 
  "3_cubic_size",       "fruitPerPlant_pheno ~ size + I(size^2) + I(size^3)"
)

#run the models 
fruits_models_pheno <- fruits_models_pheno %>%
  mutate(lm = map(f, ~ lm(as.formula(.), 
                            data = twomossize_fruits)), #run the models 
         predict = map(lm, predict), 
         glance = map(lm, glance)) #glance at the model results

fruits_models_pheno %>% select(-f, -lm, -predict) %>% unnest(glance) %>% arrange(BIC) #look at the model fitting info 
fruits_models_pheno %>% select(-f, -lm, -predict) %>% unnest(glance) %>% arrange(AIC) #look at the model fitting info 

#1_linear_size best by AIC and BIC 
```

```{r}
fruits.final_pheno <- fruits_models_pheno %>% filter(name == "1_linear_size") %>% pull(lm) %>% magrittr::extract2(1)
summary(fruits.final_pheno)
```

#### Predicted vs. Observed
```{r}
twomossize_fruits %>% 
  cbind(predicted={fruits_models_pheno %>% filter(name=="1_linear_size") %>% pull(predict) %>% unlist()}) %>%
  ggplot(aes(x=size, y = fruitPerPlant_pheno)) +
  geom_point(alpha=.2) +
  geom_line(aes(y = predicted), 
            color = "blue", size=1.2, alpha=0.3)
```

### Phenos + Genos
```{r}
fruits_models_genos <- tribble(
  ~name,          ~f,
  "1a_linear_size",      "fruitPerPlant_pheno ~ 1 + size", 
  "2a_quadratic_size",   "fruitPerPlant_pheno ~ size + I(size^2)", 
  "3a_cubic_size",       "fruitPerPlant_pheno ~ size + I(size^2) + I(size^3)",
  "1b_linear_size_genos",      "fruitPerPlant_pheno ~ 1 + size + fruitPerPlant_geno", 
  "2b_quadratic_size_genos",   "fruitPerPlant_pheno ~ size + I(size^2) + fruitPerPlant_geno", 
  "3b_cubic_size_genos",       "fruitPerPlant_pheno ~ size + I(size^2) + I(size^3) + fruitPerPlant_geno"
)

#run the models 
fruits_models_genos <- fruits_models_genos %>%
  mutate(lm = map(f, ~ lm(as.formula(.), 
                            data = twomossize_fruits)), #run the models 
         predict = map(lm, predict), 
         glance = map(lm, glance)) #glance at the model results

fruits_models_genos %>% select(-f, -lm, -predict) %>% unnest(glance) %>% arrange(BIC) #look at the model fitting info 
fruits_models_genos %>% select(-f, -lm, -predict) %>% unnest(glance) %>% arrange(AIC) #look at the model fitting info 

#1b_linear_size_genos best by AIC and BIC 
```

```{r}
fruits.final_genos <- fruits_models_genos %>% filter(name == "1b_linear_size_genos") %>% pull(lm) %>% magrittr::extract2(1)
summary(fruits.final_genos)
```

#### Predicted vs. Observed
```{r}
twomossize_fruits %>% 
  cbind(predicted={fruits_models_genos %>% filter(name=="1b_linear_size_genos") %>% pull(predict) %>% unlist()}) %>%
  ggplot(aes(x=size, y = fruitPerPlant_pheno)) +
  geom_point(alpha=.2) +
  geom_line(aes(y = predicted), 
            color = "blue", size=1.2, alpha=0.3)
```

## F Matrix 

### Make a dataframe to store the parameters
```{r}
params.rep = data.frame(
  flower.int=NA, # Intercept from log reg of flowering prob 
  flower.slope = NA, # Slope from log reg of flowering prob 
  fruit.int=NA, # Intercept from Poisson regression of fruit number
  fruit.slope=NA, # Slope from Poisson regression of fruit number
  seed.per.fruit=fec2, #seeds produced per fruit
  germ.prob=fec3, #germ prob 
  establishment.prob=fec4, # Probability of establishment
  recruit.size.mean=NA, # Mean recruit size
  recruit.size.sd=NA # Standard deviation of recruit size
)

#recruit size = size in week 1 (pre-transplant )
recruit_size <- simpop_timeprep %>% 
  filter(week==1) %>% 
  summarise(recruit.size.mean=mean(size, na.rm=TRUE), recruit.size.sd=sd(size, na.rm = TRUE))
params.rep$recruit.size.mean <- recruit_size$recruit.size.mean
params.rep$recruit.size.sd <- recruit_size$recruit.size.sd

#make separate dataframe for phenos vs. genos 
params.rep_phenos <- params.rep
params.rep_genos <- params.rep
```

### Extract the model params 
```{r}
fec0.coefs_pheno <- fec0.models_pheno %>% 
  filter(name == "1_linear_size") %>% 
  mutate(coefs = map(glm, tidy)) %>% 
  select(name, f, coefs) %>% 
  unnest(coefs) 

params.rep_phenos$flower.int <- fec0.coefs_pheno %>% filter(term == "(Intercept)") %>% pull(estimate)
params.rep_phenos$flower.slope <- fec0.coefs_pheno %>% filter(term == "size") %>% pull(estimate)
```

```{r}
fec0.coefs_genos <- fec0.models_genos %>% 
  filter(name == "1b_linear_size_genos") %>% 
  mutate(coefs = map(glm, tidy)) %>% 
  select(name, f, coefs) %>% 
  unnest(coefs) 

params.rep_genos$flower.int <- fec0.coefs_genos %>% filter(term == "(Intercept)") %>% pull(estimate)
params.rep_genos$flower.slope <- fec0.coefs_genos %>% filter(term == "size") %>% pull(estimate)
```

```{r}
fruits.coefs_pheno <- fruits_models_pheno %>% 
  filter(name == "1_linear_size") %>% 
  mutate(coefs = map(lm, tidy)) %>% 
  select(name, f, coefs) %>% 
  unnest(coefs) 

params.rep_phenos$fruit.int <- fruits.coefs_pheno %>% filter(term == "(Intercept)") %>% pull(estimate)
params.rep_phenos$fruit.slope <- fruits.coefs_pheno %>% filter(term == "size") %>%  pull(estimate) 
```

```{r}
fruits.coefs_genos <- fruits_models_genos %>% 
  filter(name == "1b_linear_size_genos") %>% 
  mutate(coefs = map(lm, tidy)) %>% 
  select(name, f, coefs) %>% 
  unnest(coefs) 

params.rep_genos$fruit.int <- fruits.coefs_genos %>% filter(term == "(Intercept)") %>% pull(estimate)
params.rep_genos$fruit.slope <- fruits.coefs_genos %>% filter(term == "size") %>%  pull(estimate) 
```

### Define the functions
```{r}
# flowering prob. function 
p.flower.x_pheno=function(x,params.rep_phenos) { #flowering prob. 
              u=exp(params.rep_phenos$flower.int+params.rep_phenos$flower.slope*x)
              return(u/(1+u)) #back transform from logit scale 
}

#fruit number function
fruit.n_pheno <- function(x, params.rep_phenos) {
  exp(params.rep_phenos$fruit.int + 
        x*params.rep_phenos$fruit.slope) #fecundity, exp to backtransform poisson 
}

#reproduction function (with above prob. and fruit functions incorporated)
f.yx_pheno=function(xp,x,params.rep_phenos) {
  #fresh seeds:
  p.flower.x_pheno(x,params.rep_phenos)* #have to flower first
    fruit.n_pheno(x, params.rep_phenos)* #then produce a certain number of fruits 
    params.rep_phenos$seed.per.fruit* #those fruits have a certain number of seeds 
    params.rep_phenos$germ.prob* #those seeds have to germinate
              params.rep_phenos$establishment.prob* #recruits have to surv post germ
              dnorm(xp,mean=params.rep_phenos$recruit.size.mean,sd=params.rep_phenos$recruit.size.sd) 
}
```

```{r}
# flowering prob. function 
p.flower.x_genos=function(x,params.rep_genos) { #flowering prob. 
              u=exp(params.rep_genos$flower.int+params.rep_genos$flower.slope*x)
              return(u/(1+u)) #back transform from logit scale 
}

#fruit number function
fruit.n_genos <- function(x, params.rep_genos) {
  exp(params.rep_genos$fruit.int + 
        x*params.rep_genos$fruit.slope) #fecundity, exp to backtransform poisson 
}

#reproduction function (with above prob. and fruit functions incorporated)
f.yx_genos=function(xp,x,params.rep_genos) {
  #fresh seeds:
  p.flower.x_genos(x,params.rep_genos)* #have to flower first
    fruit.n_genos(x, params.rep_genos)* #then produce a certain number of fruits 
    params.rep_genos$seed.per.fruit* #those fruits have a certain number of seeds 
    params.rep_genos$germ.prob* #those seeds have to germinate
              params.rep_genos$establishment.prob* #recruits have to surv post germ
              dnorm(xp,mean=params.rep_genos$recruit.size.mean,sd=params.rep_genos$recruit.size.sd) 
}
```

### Make the F matrix
```{r}
F_phenos=h*outer(y,y,f.yx_pheno,params=params.rep_phenos) # reproduction matrix

F_genos=h*outer(y,y,f.yx_genos,params=params.rep_genos) # reproduction matrix
```

### Plot the F matrix 
```{r}
F_phenos %>% as_tibble() %>%
  set_colnames(y) %>% #column names = each size mesh point 
  mutate(size.t1=y) %>%
  pivot_longer(-size.t1, names_to = "size.t", names_transform = as.numeric) %>%
  ggplot(aes(x=size.t, y = size.t1)) +
  geom_raster(aes(fill = value)) + #basic contour with fill determined by the growth*surv value 
  geom_contour(aes(z = value),lwd=.25) + #adds contour lines 
  geom_abline(intercept=0, slope = 1, color="gray90", lty=5) + #add 1:1 line 
  scale_fill_viridis_c(option = "plasma") + #change contour colors 
  labs(x = "Size (t)", y = "Size (t + 1)", title = "F Matrix: Phenos Only") +
  coord_equal() + #make it a square plot 
  theme_bw()
```
```{r}
F_genos %>% as_tibble() %>%
  set_colnames(y) %>% #column names = each size mesh point 
  mutate(size.t1=y) %>%
  pivot_longer(-size.t1, names_to = "size.t", names_transform = as.numeric) %>%
  ggplot(aes(x=size.t, y = size.t1)) +
  geom_raster(aes(fill = value)) + #basic contour with fill determined by the growth*surv value 
  geom_contour(aes(z = value),lwd=.25) + #adds contour lines 
  geom_abline(intercept=0, slope = 1, color="gray90", lty=5) + #add 1:1 line 
  scale_fill_viridis_c(option = "plasma") + #change contour colors 
  labs(x = "Size (t)", y = "Size (t + 1)", title = "F Matrix: Phenos + Genos") +
  coord_equal() + #make it a square plot 
  theme_bw()
```
### Asymptotic Lambda Comparison
```{r}
(lam_pheno = Re(eigen(F_phenos)$values[1]))  #2361860582
(lam_geno = Re(eigen(F_genos)$values[1]))  #5.237653e-06
#lambda lower with genotypes added 
#phenos --> pop growth; genos --> pop decline 
```

### Sensitivities Comparison
```{r}
#prep:
w.eigen_pheno <- Re(eigen(F_phenos)$vectors[,1]) #right eigenvector
stable.dist_pheno <- w.eigen_pheno/sum(w.eigen_pheno)
v.eigen_pheno <- Re(eigen(t(F_phenos))$vectors[,1]) #left eigenvector 
repro.val_pheno <- v.eigen_pheno/v.eigen_pheno[1]

w.eigen_geno <- Re(eigen(F_genos)$vectors[,1]) #right eigenvector
stable.dist_geno <- w.eigen_geno/sum(w.eigen_geno)
v.eigen_geno <- Re(eigen(t(F_genos))$vectors[,1]) #left eigenvector 
repro.val_geno <- v.eigen_geno/v.eigen_geno[1]

#combine eigens to get sensitivity and elasticity matrices
v.dot.w_pheno = sum(stable.dist_pheno*repro.val_pheno)*h
sens_pheno = outer(repro.val_pheno,stable.dist_pheno)/v.dot.w_pheno
elas_pheno = matrix(as.vector(sens_pheno)*as.vector(F_phenos)/lam_pheno,nrow=n)

v.dot.w_geno = sum(stable.dist_geno*repro.val_geno)*h
sens_geno = outer(repro.val_geno,stable.dist_geno)/v.dot.w_geno
elas_geno = matrix(as.vector(sens_geno)*as.vector(F_genos)/lam_geno,nrow=n)

sens_pheno
sens_geno
#sensitivities are different 

elas_pheno
elas_geno 
#elasticities are different 
```

## Combine P and F matrices to make the IPM (K Matrix)
```{r}
K_pheno=P_phenos + F_phenos                             # full matrix 
K_genos=P_genos + F_genos                             # full matrix 
```

### Plot the matrix
```{r}
K_pheno %>% as_tibble() %>%
   set_colnames(y) %>% #column names = each size mesh point 
  mutate(size.t1=y) %>%
  pivot_longer(-size.t1, names_to = "size.t", names_transform = as.numeric) %>%
  ggplot(aes(x=size.t, y = size.t1)) +
  geom_raster(aes(fill = value)) + #basic contour with fill determined by the growth*surv value 
  geom_contour(aes(z = value),lwd=.25) + #adds contour lines 
  geom_abline(intercept=0, slope = 1, color="gray90", lty=5) + #add 1:1 line 
  scale_fill_viridis_c(option = "plasma") + #change contour colors 
  labs(x = "Size (t)", y = "Size (t + 1)", title = "IPM: Phenos Only") +
  coord_equal() + #make it a square plot 
  theme_bw()
```
```{r}
K_genos %>% as_tibble() %>%
   set_colnames(y) %>% #column names = each size mesh point 
  mutate(size.t1=y) %>%
  pivot_longer(-size.t1, names_to = "size.t", names_transform = as.numeric) %>%
  ggplot(aes(x=size.t, y = size.t1)) +
  geom_raster(aes(fill = value)) + #basic contour with fill determined by the growth*surv value 
  geom_contour(aes(z = value),lwd=.25) + #adds contour lines 
  geom_abline(intercept=0, slope = 1, color="gray90", lty=5) + #add 1:1 line 
  scale_fill_viridis_c(option = "plasma") + #change contour colors 
  labs(x = "Size (t)", y = "Size (t + 1)", title = "IPM: Phenos + Genos") +
  coord_equal() + #make it a square plot 
  theme_bw()
```

### Asymptotic Lambda Comparison
```{r}
(lam_pheno = Re(eigen(K_pheno)$values[1]))  #2361860584
(lam_geno = Re(eigen(K_genos)$values[1]))  #0.9866669
#lambda lower with genotypes added 
#phenos --> pop growth; genos --> pop decline 
```

### Sensitivities Comparison
```{r}
#prep:
w.eigen_pheno <- Re(eigen(K_pheno)$vectors[,1]) #right eigenvector
stable.dist_pheno <- w.eigen_pheno/sum(w.eigen_pheno)
v.eigen_pheno <- Re(eigen(t(K_pheno))$vectors[,1]) #left eigenvector 
repro.val_pheno <- v.eigen_pheno/v.eigen_pheno[1]

w.eigen_geno <- Re(eigen(K_genos)$vectors[,1]) #right eigenvector
stable.dist_geno <- w.eigen_geno/sum(w.eigen_geno)
v.eigen_geno <- Re(eigen(t(K_genos))$vectors[,1]) #left eigenvector 
repro.val_geno <- v.eigen_geno/v.eigen_geno[1]

#combine eigens to get sensitivity and elasticity matrices
v.dot.w_pheno = sum(stable.dist_pheno*repro.val_pheno)*h
sens_pheno = outer(repro.val_pheno,stable.dist_pheno)/v.dot.w_pheno
elas_pheno = matrix(as.vector(sens_pheno)*as.vector(K_pheno)/lam_pheno,nrow=n)

v.dot.w_geno = sum(stable.dist_geno*repro.val_geno)*h
sens_geno = outer(repro.val_geno,stable.dist_geno)/v.dot.w_geno
elas_geno = matrix(as.vector(sens_geno)*as.vector(K_genos)/lam_geno,nrow=n)

sens_pheno
sens_geno
#sensitivities are different 

elas_pheno
elas_geno 
#elasticities are different 
```